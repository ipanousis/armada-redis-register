#!/usr/bin/python

import json,os,sys,redis,requests,time
import logging
import re

if "DEBUG" in os.environ:
	logging.basicConfig(level=logging.DEBUG)


CLUSTER_NAME=os.environ['FLOCKER_DOMAIN']

# in a but not b
def diff(a, b):
	b = set(b)
	return [aa for aa in a if aa not in b]

def intersect(a, b):
	return list(set(a) & set(b))



class Service:

  def __init__(self, id, host, instance):
    self.id = id
    self.host = host
    self.instance = instance


def updateProxy(svc, rs):
  key = "frontend:" + svc.host

  if not rs.exists(key):
    rs.rpush(key, svc.id)

  rs.expire(key, 15)

  existing = rs.lrange(key, 0, -1)

  current = [svc.instance]
  current.insert(0, svc.id)

  toDelete = diff(existing, current)
  toAdd = diff(current, existing)

  for val in toDelete:
    logging.info("D "+key+" "+val)
    rs.lrem(key, val)

  for val in toAdd:
    logging.info("A "+key+" "+val)
    rs.rpushx(key, val)	


#redisAdd = os.environ['REDIS'].split(":")

#rs = redis.Redis(redisAdd[0], int(redisAdd[1]))

#obj = requests.get("http://"+os.environ['ETCD']+"/v2/keys/backends/?recursive=true").json()

#backends = obj['node']['nodes']

backends = []

{{ $local := . }}
{{range $key, $value := .}}

# {{ $value.Name }}
{{ $tag := "latest" }}
{{ if $value.Image.Tag }}
{{ $tag := $value.Image.Tag }}
{{end}}

running_container = {
                      "host"       : "{{ $local.Env.HOST_IP }}",
                      "container_id" : "{{ printf "%.*s" 24 $value.ID }}",
                      "name"       : "{{ $value.Name }}",
                      "registry"   : "{{ $value.Image.Registry }}",
                      "repository" : "{{ $value.Image.Repository }}",
                      "tag"        : "{{ $tag }}",
                      "addresses"  : "{{ $value.Addresses }}"
                    }

#running_container['addresses'] = "[{172.17.0.3 2379 } {172.17.0.3 2380 } {172.17.0.3 4001 4001} {172.17.0.3 7001 }]"
address_string = running_container['addresses'].replace('} {','},{').replace('{','"').replace('}','"')
address_list = [re.sub(' +',' ',item.strip()).split(' ') for item in eval(address_string)]
port_dicts = []
for item in address_list:
  parts_no = len(item)
  internal_port, host_port = item[1], None
  if parts_no > 3:
    host_port = item[2]
  port_dicts.append({'internal':internal_port, 'external':host_port})

del running_container['addresses']
running_container['ports'] = port_dicts

backends.append(running_container)

{{end}}

print 'Total backends: %d' % len(backends)

redis_host_port = os.environ['REDIS_HOST'].split(':')
redis_port = (int(redis_host_port[1]) if len(redis_host_port) == 2 else 6379)
rs = redis.Redis(redis_host_port[0], redis_port)

get_port_protocol = lambda port : 'https' if port == 443 else 'http'

for svc in backends:

  if not 'flocker--' in svc['name']:
    continue

  svc_name = svc['name'].replace('flocker--','')

  exposed_ports = [port for port in svc['ports'] if port['external'] != None]
  if len(exposed_ports) > 0:
    exposed_port = exposed_ports[0]
    redis_svc = Service(svc_name, svc_name + '.' + CLUSTER_NAME, get_port_protocol(exposed_port['internal']) + '://' + CLUSTER_NAME + ':' + exposed_port['external'] )
    print 'Redis Entry: (id, host, instance) = (%s, %s, %s)' % (redis_svc.id, redis_svc.host, redis_svc.instance)
    updateProxy(redis_svc, rs)


  for exposed_port in exposed_ports:
    redis_svc_name = exposed_port['internal'] + '.' + svc_name
    redis_svc = Service(redis_svc_name, redis_svc_name + '.' + CLUSTER_NAME, get_port_protocol(exposed_port['internal'] + '://' + CLUSTER_NAME + ':' + exposed_port['external'] )
    print 'Redis Entry: (id, host, instance) = (%s, %s, %s)' % (redis_svc.id, redis_svc.host, redis_svc.instance)
    updateProxy(redis_svc, rs)

logging.info("exiting...")
